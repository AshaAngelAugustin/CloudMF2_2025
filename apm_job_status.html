<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>APM Job Status Viewer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
        .container { background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; max-width: 900px; margin: auto; }
        h2 { margin-bottom: 16px; text-align: center; font-size: 2.2em; }
        input[type="file"] { margin-bottom: 16px; }
        select, input[type="text"], input[type="date"] { margin: 0 8px 16px 0; padding: 6px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #b3d8fd; }
        tr:nth-child(even) { background: #fff; }
    </style>
</head>
<body>
<div class="container">
    <h2>Application Job Status</h2>
    <button onclick="location.reload()" style="margin-bottom:16px;">Refresh Page</button>
    <label for="csvFile">Upload Excel file (.xlsx):</label>
    <input type="file" id="csvFile" accept=".xlsx">
    <br>
    <label for="apmSelect" style="font-weight:bold;">APP Name:</label>
    <select id="apmSelect"><option value="">-- Select --</option></select>
    <label for="datePicker" style="font-weight:bold; margin-left:16px;">Date:</label>
    <input type="date" id="datePicker" style="margin-bottom:16px;">
    <br>
    <h3 id="summaryTitle" style="display:none;">Application Summary</h3>
    <table id="summaryTable" style="display:none;">
        <thead>
            <tr>
                <th>Application Name</th>
                <th>Date</th>
                <th>Job Count</th>
                <th>Job Status Count</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <table id="jobTable">
        <thead>
            <tr>
                <th>Application Name</th>
                <th>Parent Job</th>
                <th>Job Status</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
function parseExcel(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
        callback(json);
    };
    reader.readAsArrayBuffer(file);
}

function formatDate(dateVal) {
    if (dateVal === undefined || dateVal === null || dateVal === '') return '';
    // Excel serial date (number)
    if (typeof dateVal === 'number' || (!isNaN(dateVal) && String(dateVal).trim() !== '')) {
        let num = Number(dateVal);
        if (num > 59 && num < 60000) {
            const excelEpoch = new Date(Date.UTC(1899, 11, 30));
            const d = new Date(excelEpoch.getTime() + num * 24 * 60 * 60 * 1000);
            return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
        }
    }
    const d = new Date(dateVal);
    if (!isNaN(d)) {
        return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear();
    }
    return '';
}

function detectJobStatusColumn(data) {
    if (!data.length) return null;
    const headers = Object.keys(data[0]);
    for (const h of headers) {
        const values = data.map(row => (row[h] || '').toLowerCase());
        if (values.some(v => v === 'pass' || v === 'failed' || v === 'fail')) {
            return h;
        }
    }
    return null;
}

function detectApplicationNameColumn(data) {
    if (!data.length) return 'APM Name';
    const headers = Object.keys(data[0]);
    // Try to find a column that matches APM Name or Application Name
    for (const h of headers) {
        if (h.toLowerCase().includes('apm name') || h.toLowerCase().includes('application name')) {
            return h;
        }
    }
    // Fallback to first column
    return headers[0];
}

let jobs = [];
let filteredJobs = [];
let jobStatusCol = 'Job status';
let applicationNameCol = 'APM Name';

const csvFile = document.getElementById('csvFile');
const apmSelect = document.getElementById('apmSelect');
const datePicker = document.getElementById('datePicker');
const jobTableBody = document.querySelector('#jobTable tbody');
const summaryTable = document.getElementById('summaryTable');
const summaryTableBody = document.querySelector('#summaryTable tbody');
const summaryTitle = document.getElementById('summaryTitle');

csvFile.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (file.name.endsWith('.xlsx')) {
        parseExcel(file, function(data) {
            jobs = data;
            jobStatusCol = detectJobStatusColumn(jobs) || 'Job status';
            applicationNameCol = detectApplicationNameColumn(jobs);
            populateAPMNames();
            displayJobs(jobs);
            summaryTable.style.display = 'none';
            summaryTitle.style.display = 'none';
        });
    }
});

function populateAPMNames() {
    const apmNames = [...new Set(jobs.map(j => j[applicationNameCol]))].filter(Boolean);
    apmSelect.innerHTML = '<option value="">-- Select --</option>' + apmNames.map(n => `<option value="${n}">${n}</option>`).join('');
}

function displayJobs(data) {
    jobTableBody.innerHTML = data.map(j => {
        const status = (j[jobStatusCol] || '');
        const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
        const statusDisplay = statusLabel === 'Failed'
            ? `<span style='color:#FFA500;'>${statusLabel}</span>`
            : statusLabel;
        return `
        <tr>
            <td>${j[applicationNameCol]}</td>
            <td>${j['Parent Job']}</td>
            <td>${statusDisplay}</td>
            <td>${formatDate(j['Date'])}</td>
        </tr>
        `;
    }).join('');
}

function filterAndDisplay() {
    const apm = apmSelect.value;
    const selectedDate = datePicker.value;
    let filtered = jobs;
    if (apm) {
        filtered = filtered.filter(j => j[applicationNameCol] === apm);
    }
    if (selectedDate) {
        const formattedDate = selectedDate.split('-').reverse().join('/');
        filtered = filtered.filter(j => formatDate(j['Date']) === formattedDate);
    }
    displayJobs(filtered);
    showSummary(apm, selectedDate);
}

apmSelect.addEventListener('change', filterAndDisplay);
datePicker.addEventListener('change', filterAndDisplay);

function showSummary(apm, selectedDate) {
    if (!apm && !selectedDate) {
        summaryTable.style.display = 'none';
        summaryTitle.style.display = 'none';
        return;
    }
    let apmJobs = jobs;
    if (apm) {
        apmJobs = apmJobs.filter(j => j[applicationNameCol] === apm);
    }
    if (selectedDate) {
        const formattedDate = selectedDate.split('-').reverse().join('/');
        apmJobs = apmJobs.filter(j => formatDate(j['Date']) === formattedDate);
    }
    // Group jobs by distinct date
    const dateGroups = {};
    apmJobs.forEach(j => {
        const date = formatDate(j['Date']);
        if (!date) return;
        if (!dateGroups[date]) dateGroups[date] = [];
        dateGroups[date].push(j);
    });
    // For each date, show job count and job status count
    const rows = Object.entries(dateGroups).map(([date, jobsOnDate]) => {
        const jobCount = jobsOnDate.length;
        const statusCounts = jobsOnDate.reduce((acc, j) => {
            const status = (j[jobStatusCol] || '').toLowerCase();
            if (status) acc[status] = (acc[status] || 0) + 1;
            return acc;
        }, {});
        const jobStatusCount = Object.entries(statusCounts)
            .map(([k, v]) => {
                const label = k.charAt(0).toUpperCase() + k.slice(1);
                if (label === 'Failed') {
                    return `<span style='color:#FFA500;'>${label}: ${v}</span>`;
                }
                return `${label}: ${v}`;
            })
            .join(', ');
        return `<tr>
            <td>${apm || jobsOnDate[0][applicationNameCol]}</td>
            <td>${date}</td>
            <td>${jobCount}</td>
            <td>${jobStatusCount}</td>
        </tr>`;
    }).join('');
    summaryTableBody.innerHTML = rows;
    summaryTable.style.display = '';
    summaryTitle.style.display = '';
}
</script>
</body>
</html>
